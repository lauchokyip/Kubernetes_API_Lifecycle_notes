# Kubectl to API server note
![API lifecycle](APIifecycle.png)


## Client Side
kubectl makes HTTP POST request to kube-api-server and kube-api-server returns with HTTP response. Let's dive deep into it. </br>
**Kubectl POST request:**
* kubectl will use [Factory abstraction](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/kubectl/pkg/cmd/util/factory.go#L40) to execute kubectl
* Inside [Factory](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/kubectl/pkg/cmd/util/factory.go#L40) we will have a [builder](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/kubectl/pkg/cmd/util/factory.go#L54) 
* This [line](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/kubectl/pkg/cmd/create/create.go#L252) will create a [builder](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/kubectl/pkg/cmd/util/factory.go#L54) which is responsible for taking the data that pass in via `-f` flag or `-k` flags (which is usually a YAML file), unpack it and turn it into iterable list of Kubernetes Objects such that each Object will have generic REST operation performed on it.
* For each resource a [NewHelper](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/kubectl/pkg/cmd/create/create.go#L286) function will be created which will provide methods for running generic RESTful operations. This helper will have methods([Get](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L78),[POST](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L167) , etc etc)
* [Create](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/kubectl/pkg/cmd/create/create.go#L289) will then be called to create a Resource which will be done [here](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L166). 
* It will then make a [POST](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L167) request to the server by creating a new [Request struct](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/client-go/rest/request.go#L118) and change the [verb](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/client-go/rest/request.go#L99) into **POST**
* As we saw, the helper uses [REST client to build and execute the POST request](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L167) and a big part of that is to build the [body](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/cli-runtime/pkg/resource/helper.go#L171) of the request. (Building this body will allow us to send HTTP request.)
* Before sending any requests, we would need to [build a new **Request**](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/client-go/rest/client.go#L170) that can be send across the wire and understood by the API server and must be [serialized](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/client-go/rest/request.go#L453). [Here](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/client-go/rest/request.go#L425) we will fill out the **Body of the Request** using string, []byte, io.Reader and runtime.Object. The last step will be to send the HTTP request which will be done [here](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/client-go/rest/request.go#L978). The [request](https://github.com/kubernetes/kubernetes/blob/7cea81ce34c4aa7d0e952d7f9957db254e3fbc83/staging/src/k8s.io/client-go/rest/request.go#L849) method will request connects to the server and invokes the [transformFunction](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/client-go/rest/request.go#L1006) when a server response is received whereas the [transfromFunction](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/client-go/rest/request.go#L1006) converts an API response into a structured API object. </br> </br>
**Serialization:** </br>
* Now, let's look at how seriliazation work. [Here](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/apimachinery/pkg/runtime/interfaces.go#L86) is where Serializer Object sits at. The[Encoder](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/apimachinery/pkg/runtime/interfaces.go#L52) is responsible for converting a Kubernetes Object Go struct in memory into the cononicla wire format to send scross the wire to the API server. Conversely, the [Decoder](https://github.com/kubernetes/kubernetes/blob/d88d9ac3b4eff86de439d65558a918a4d5fe962d/staging/src/k8s.io/apimachinery/pkg/runtime/interfaces.go#L73) is responsible for converting back the wire format into Kubernetes Object Go struct.
* Noticed that Kubernetes Object Go struct has to satisfy the [runtime.Object interfaces](https://github.com/kubernetes/apimachinery/blob/2456ebdaba229616fab2161a615148884b46644b/pkg/runtime/interfaces.go#L299) so All Kubernetes Obejct like Replica Sets, Service, Config Map, etc etc **have to implement this interfaces**.
 
 ## Server Side:
References: </br>
[Google Open Source Live presents Kubernetes (R) | Full Event](https://www.youtube.com/watch?v=60fnBk14ifc) <br>


